import * as Plot from "@observablehq/plot";
import * as d3 from "d3";
import {useEffect, useRef, useState} from "react";

function CandleStickPlot() {
  const containerRef = useRef();
  const [data, setData] = useState();
  const color = { domain: [-1, 0, 1], range: ["#e41a1c", "#000000", "#4daf4a"] }

let newData = [{"v":1.90283951e+08,"vw":121.0363,"o":118.96,"c":119.77,"h":123.52,"l":117.11,"t":1673240400000,"n":1740776},{"v":1.67603486e+08,"vw":117.8401,"o":121.07,"c":118.85,"h":122.76,"l":114.92,"t":1673326800000,"n":1402648},{"v":1.83810771e+08,"vw":122.6777,"o":122.09,"c":123.22,"h":125.95,"l":120.51,"t":1673413200000,"n":1509956},{"v":1.69400913e+08,"vw":121.0372,"o":122.56,"c":123.56,"h":124.1311,"l":117,"t":1673499600000,"n":1432274},{"v":1.80714119e+08,"vw":119.4746,"o":116.55,"c":122.4,"h":122.63,"l":115.6,"t":1673586000000,"n":1430041},{"v":1.86476985e+08,"vw":129.3585,"o":125.695,"c":131.49,"h":131.7,"l":125.02,"t":1673931600000,"n":1495231},{"v":1.95526818e+08,"vw":130.7704,"o":136.555,"c":128.78,"h":136.68,"l":127.01,"t":1674018000000,"n":1541859},{"v":1.7028788e+08,"vw":127.1985,"o":127.26,"c":127.17,"h":129.99,"l":124.3082,"t":1674104400000,"n":1156273},{"v":1.38858136e+08,"vw":131.0354,"o":128.68,"c":133.42,"h":133.51,"l":127.3466,"t":1674190800000,"n":991848},{"v":2.02107061e+08,"vw":141.1574,"o":135.87,"c":143.75,"h":145.3793,"l":134.27,"t":1674450000000,"n":1479332},{"v":1.58669331e+08,"vw":143.5041,"o":143,"c":143.89,"h":146.5,"l":141.1,"t":1674536400000,"n":1176066},{"v":1.92731847e+08,"vw":143.3163,"o":141.905,"c":144.43,"h":146.41,"l":138.07,"t":1674622800000,"n":1579530},{"v":2.3470879e+08,"vw":157.8064,"o":159.965,"c":160.27,"h":161.42,"l":154.76,"t":1674709200000,"n":2046126},{"v":3.06542013e+08,"vw":172.965,"o":162.43,"c":177.9,"h":180.68,"l":161.17,"t":1674795600000,"n":2631365},{"v":2.30862447e+08,"vw":172.279,"o":178.05,"c":166.66,"h":179.77,"l":166.5,"t":1675054800000,"n":2010138},{"v":1.96729941e+08,"vw":170.7898,"o":164.57,"c":173.22,"h":174.3,"l":162.78,"t":1675141200000,"n":1496828},{"v":2.13761623e+08,"vw":175.8396,"o":173.89,"c":181.41,"h":183.805,"l":169.93,"t":1675227600000,"n":1598173},{"v":2.17448287e+08,"vw":190.5211,"o":187.325,"c":188.27,"h":196.7501,"l":182.61,"t":1675314000000,"n":1949049},{"v":2.32595013e+08,"vw":193.3842,"o":183.95,"c":189.98,"h":199,"l":183.69,"t":1675400400000,"n":1969265},{"v":1.86180031e+08,"vw":194.5538,"o":193.01,"c":194.76,"h":198.17,"l":189.92,"t":1675659600000,"n":1591557},{"v":1.85997767e+08,"vw":194.1225,"o":196.43,"c":196.81,"h":197.5,"l":189.55,"t":1675746000000,"n":1547233},{"v":1.80612134e+08,"vw":200.2789,"o":196.1,"c":201.29,"h":203,"l":194.31,"t":1675832400000,"n":1575281},{"v":2.15431442e+08,"vw":209.9267,"o":207.775,"c":207.32,"h":214,"l":204.77,"t":1675918800000,"n":2118951},{"v":2.04754129e+08,"vw":198.1208,"o":202.225,"c":196.89,"h":206.2,"l":192.89,"t":1676005200000,"n":1957749},{"v":1.72475452e+08,"vw":193.2998,"o":194.415,"c":194.64,"h":196.3,"l":187.61,"t":1676264400000,"n":1522129},{"v":2.16334008e+08,"vw":201.8225,"o":191.94,"c":209.25,"h":209.82,"l":189.44,"t":1676350800000,"n":1819451},{"v":1.82016181e+08,"vw":211.6085,"o":211.755,"c":214.24,"h":214.66,"l":206.11,"t":1676437200000,"n":1666645},{"v":2.29558338e+08,"vw":211.3216,"o":210.78,"c":202.04,"h":217.65,"l":201.84,"t":1676523600000,"n":2110972},{"v":2.13728549e+08,"vw":202.9642,"o":199.985,"c":208.31,"h":208.44,"l":197.5,"t":1676610000000,"n":1836021},{"v":1.79997088e+08,"vw":202.4126,"o":204.99,"c":197.37,"h":209.71,"l":197.22,"t":1676955600000,"n":1812467},{"v":1.91730657e+08,"vw":197.461,"o":197.93,"c":200.86,"h":201.99,"l":191.78,"t":1677042000000,"n":1620639},{"v":1.4635995e+08,"vw":200.6393,"o":203.91,"c":202.07,"h":205.14,"l":196.33,"t":1677128400000,"n":1294328},{"v":1.42221085e+08,"vw":195.575,"o":196.325,"c":196.88,"h":197.6695,"l":192.8,"t":1677214800000,"n":1355710},{"v":1.61026215e+08,"vw":206.3174,"o":202.03,"c":207.63,"h":209.42,"l":201.26,"t":1677474000000,"n":1526655},{"v":1.53140787e+08,"vw":207.0803,"o":210.59,"c":205.71,"h":211.23,"l":203.75,"t":1677560400000,"n":1422655},{"v":1.5683779e+08,"vw":201.4307,"o":206.21,"c":202.77,"h":207.2,"l":198.52,"t":1677646800000,"n":1412446},{"v":1.81943904e+08,"vw":190.0234,"o":186.74,"c":190.9,"h":193.7499,"l":186.01,"t":1677733200000,"n":1843861},{"v":1.54150777e+08,"vw":197.507,"o":194.795,"c":197.79,"h":200.48,"l":192.88,"t":1677819600000,"n":1388271},{"v":1.28086106e+08,"vw":195.2121,"o":198.54,"c":193.81,"h":198.6,"l":192.3,"t":1678078800000,"n":1172406},{"v":1.4812579e+08,"vw":190.1195,"o":191.38,"c":187.71,"h":194.2,"l":186.1,"t":1678165200000,"n":1386300},{"v":1.51731963e+08,"vw":181.8242,"o":185.04,"c":182,"h":186.5,"l":180,"t":1678251600000,"n":1422858},{"v":1.70023794e+08,"vw":178.8095,"o":180.25,"c":172.92,"h":185.18,"l":172.5124,"t":1678338000000,"n":1708131},{"v":1.91488872e+08,"vw":174.2728,"o":175.13,"c":173.44,"h":178.29,"l":168.44,"t":1678424400000,"n":1624263},{"v":1.67790256e+08,"vw":171.6746,"o":167.455,"c":174.48,"h":177.35,"l":163.91,"t":1678680000000,"n":1583454},{"v":1.43717897e+08,"vw":181.1945,"o":177.31,"c":183.26,"h":183.8,"l":177.1401,"t":1678766400000,"n":1184341},{"v":1.45973833e+08,"vw":179.3899,"o":180.8,"c":180.45,"h":182.34,"l":176.03,"t":1678852800000,"n":1283031},{"v":1.21364253e+08,"vw":182.9179,"o":180.365,"c":184.13,"h":185.81,"l":178.84,"t":1678939200000,"n":1120979},{"v":1.3258214e+08,"vw":180.4693,"o":184.515,"c":180.13,"h":186.2199,"l":177.33,"t":1679025600000,"n":1174346},{"v":1.29284359e+08,"vw":182.8769,"o":178.08,"c":183.25,"h":186.44,"l":176.35,"t":1679284800000,"n":1179253},{"v":1.53391444e+08,"vw":193.691,"o":188.28,"c":197.58,"h":198,"l":188.04,"t":1679371200000,"n":1456132},{"v":1.50370133e+08,"vw":196.6986,"o":199.3,"c":191.15,"h":200.66,"l":190.95,"t":1679457600000,"n":1424877},{"v":1.44193876e+08,"vw":194.6499,"o":195.26,"c":192.22,"h":199.31,"l":188.65,"t":1679544000000,"n":1324622},{"v":1.16511584e+08,"vw":189.5479,"o":191.65,"c":190.41,"h":192.36,"l":187.15,"t":1679630400000,"n":1094605},{"v":1.20851587e+08,"vw":193.7046,"o":194.415,"c":191.81,"h":197.39,"l":189.94,"t":1679889600000,"n":1116466},{"v":9.8654635e+07,"vw":188.2527,"o":192,"c":189.19,"h":192.35,"l":185.43,"t":1679976000000,"n":981383},{"v":1.23660026e+08,"vw":192.3766,"o":193.13,"c":193.88,"h":195.29,"l":189.44,"t":1680062400000,"n":1020355},{"v":1.10247738e+08,"vw":195.8746,"o":195.58,"c":195.28,"h":197.33,"l":194.42,"t":1680148800000,"n":1019986},{"v":1.70206718e+08,"vw":203.6711,"o":197.53,"c":207.46,"h":207.79,"l":197.2,"t":1680235200000,"n":1519289},{"v":1.69239e+08,"vw":196.0193,"o":199.91,"c":194.77,"h":202.6897,"l":192.2,"t":1680494400000,"n":1819568},{"v":1.26444045e+08,"vw":193.0305,"o":197.32,"c":192.58,"h":198.7446,"l":190.32,"t":1680580800000,"n":1456294},{"v":1.33882193e+08,"vw":186.3169,"o":190.515,"c":185.52,"h":190.68,"l":183.76,"t":1680667200000,"n":1507797},{"v":1.23857932e+08,"vw":184.0636,"o":183.08,"c":185.06,"h":186.39,"l":179.74,"t":1680753600000,"n":1178038}]

newData = newData.map(obj => {
  obj['High'] = obj['h']
  delete obj['h']
  obj['Low'] = obj['l']
  delete obj['l']
  obj['Open'] = obj['o']
  delete obj['o']
  obj['Close'] = obj['c']
  delete obj['c']
  obj['Date'] = obj['t']
  delete obj['t']
  return obj
})

useEffect(() => {



  setData(newData)
}, [])




  useEffect(() => {
    if (data === undefined) return;
    const plot = Plot.plot({
        inset: 6,
        width: 960,
        grid: true,
        // x: {
        //   // week days
        //   domain: d3.utcDays(...d3.extent(data, (d) => d.Date))
        //     .filter((d) => d.getUTCDay() > 0 && d.getUTCDay() < 6),
        //   // Monday ticks
        //   ticks: d3.utcMondays(...d3.extent(data, (d) => d.Date)),
        //   tickFormat: "%-m/%-d",
        //   label: null
        // },
        y: {
          label: "Stocks"
        },
        color,
        marks: [
          Plot.ruleY(data, Plot.selectFirst({
            y: d => d.Open,
            stroke: 'grey',
            strokeDasharray: "3,2",
          })),
          Plot.ruleX(data, {
            x: d3.utcDay(Date),
            y1: "Low",
            y2: "High"
          }),
          Plot.ruleX(data, {
            x: "Date",
            y1: "Open",
            y2: "Close",
            stroke: (d) => Math.sign(d.Close - d.Open),
            strokeWidth: 4,
            strokeLinecap: "round"
          }),
        ]
      });
    containerRef.current.append(plot);
    return () => plot.remove();
  }, [data]);

  return <div ref={containerRef} />;
}

export default CandleStickPlot;